name: Testing Auth
on: 
  workflow_dispatch:
jobs:
  nuke-aws:
    runs-on: ubuntu-latest
    env:
      IAM_USERS_LIST: ${{ secrets.SAFE_USERS }} 
      
    steps:
      - name: Get code
        uses: actions/checkout@v6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.SECRET_KEY }}
          aws-region: ap-south-1

      - name: Safety Check
        shell: bash
        run: |
          IFS=',' read -r -a USERS <<< "$IAM_USERS_LIST"

          SAFE_WINDOW=259200
          CURRENT_TIME=$(date +%s)
          
          echo "Checking login activity for: ${USERS[@]}"

          # 3. Loop through the generated array
          for user in "${USERS[@]}"; do
            
            user=$(echo "$user" | xargs)

            echo "Checking user: $user"
            USER_INFO=$(aws iam get-user --user-name "$user" 2>/dev/null)
            
             if [ $? -ne 0 ]; then
               echo "User $user not found. Skipping."
               continue
             fi

             LAST_LOGIN_ISO=$(echo "$USER_INFO" | jq -r '.User.PasswordLastUsed // "None"')

             if [ "$LAST_LOGIN_ISO" != "None" ]; then
                LAST_LOGIN_TS=$(date -d "$LAST_LOGIN_ISO" +%s)
                DIFF=$((CURRENT_TIME - LAST_LOGIN_TS))
                
                if [ "$DIFF" -lt "$SAFE_WINDOW" ]; then
                  echo "ðŸ›‘ STOP: User $user logged in recently. ABORTING."
                  exit 1
                fi
             fi
          done
          
          echo "âœ… All checks passed. Proceeding to nuke..."

      - name: Download AWS Nuke
        if: failure()
        id: nuke
        run: |
          curl -sL https://github.com/ekristen/aws-nuke/releases/download/v3.62.2/aws-nuke-v3.62.2-linux-amd64.tar.gz -o nuke.tar.gz
          tar -xzf nuke.tar.gz
          ls -F
          chmod +x aws-nuke

      - name: Run AWS Nuke
        id: aws-nuke
        if: always()
        run: |
          ./aws-nuke run --config nuke-config.yml \
          --access-key-id ${{ secrets.ACCESS_KEY }} \
          --secret-access-key ${{ secrets.SECRET_KEY }} \
          --default-region "ap-south-1" \
          --log-level "info" \
          --no-alias-check \
          --log-force-colors \
          --log-full-timestamp \
          --no-prompt \
          --no-dry-run \
          --prompt-delay 10 > nuke-output

      - name: Upload Nuke Output
        if: always() || steps.aws-nuke.outcome == 'true'
        uses: actions/upload-artifact@v4
        with: 
          name: nuke-report
          path: nuke-output