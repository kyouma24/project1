name: Testing Auth
on: 
  push: 
  workflow_dispatch:
jobs:
  nuke-aws:
    runs-on: ubuntu-latest
    env:
      IAM_USERS_LIST: ${{ secrets.SAFE_USERS }} 
      
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.SECRET_KEY }}
          aws-region: ap-south-1

      - name: Safety Check
        shell: bash
        run: |
          IFS=',' read -r -a USERS <<< "$IAM_USERS_LIST"

          SAFE_WINDOW=259200
          CURRENT_TIME=$(date +%s)
          
          echo "Checking login activity for: ${USERS[@]}"

          # 3. Loop through the generated array
          for user in "${USERS[@]}"; do
            
             # Clean up any accidental whitespace around names
            user=$(echo "$user" | xargs)

            echo "Checking user: $user"
            USER_INFO=$(aws iam get-user --user-name "$user" 2>/dev/null)
            
            # ... (Rest of logic is the same) ...
             if [ $? -ne 0 ]; then
               echo "User $user not found. Skipping."
               continue
             fi

             LAST_LOGIN_ISO=$(echo "$USER_INFO" | jq -r '.User.PasswordLastUsed // "None"')

             if [ "$LAST_LOGIN_ISO" != "None" ]; then
                LAST_LOGIN_TS=$(date -d "$LAST_LOGIN_ISO" +%s)
                DIFF=$((CURRENT_TIME - LAST_LOGIN_TS))
                
                if [ "$DIFF" -lt "$SAFE_WINDOW" ]; then
                  echo "ðŸ›‘ STOP: User $user logged in recently. ABORTING."
                  exit 1
                fi
             fi
          done
          
          echo "âœ… All checks passed. Proceeding to nuke..."

      - name: Run AWS Nuke
        if: failure() # Only run if the previous step succeeded
        run: |
          wget -c https://github.com/rebuy-de/aws-nuke/releases/download/v2.25.0/aws-nuke-v2.25.0-linux-amd64.tar.gz -O - | tar -xz -C ./
          ls